<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Admin">
	<select id="adminWeekStatus" parameterType="String"
		resultType="com.needle.FsoFso.admin.dto.DailyDetailDto">
		select a.created_at as date, sum(b.total_price) as sales, count(b.id) as salesCnt, a.memcnt as signinCnt 
		from (select count(substring(mem.created_at, 1, 10)) as memcnt, substring(mem.created_at, 1, 10) as d, mem.created_at as created_at
					from members as mem
					where substring(mem.created_at, 1, 10) = #{day}) as a, orders b
		where substring(b.ordered_at, 1, 10) = a.d;
	</select>

	<select id="adminMemberList"
		resultType="com.needle.FsoFso.admin.dto.AdminMemberDto">
		select c.id as id, c.age_range as ageRange, c.nickname as nickname, c.gender as gender, d.purchasesCount as purchasesCount, d.totalPurchase as totalPurchase, c.created_at as createdAt, c.updated_at as updatedAt
		from members as c
		LEFT JOIN (select  a.id as id, count(*) as purchasesCount, sum(b.total_price) as totalPurchase
						from members a, orders b
						where a.id = b.member_id
						group by a.id) as d
		on c.id = d.id;
	</select>

	<select id="adminProductList"
		resultType="com.needle.FsoFso.admin.dto.AdminProductDto">
		select c.id as productId, c.thumbnail_url as imgUrl, c.name as productName, c.stock as stock, d.salesCount as salesCount, c.created_at as createdAt, c.updated_at as updatedAt
		from products as c
		LEFT JOIN (select sum(b.quantity) as salesCount, a.id as product_id
						from products a, order_product b
						where a.id = b.product_id
						group by a.id) as d
		on c.id = d.product_id;
	</select>

</mapper>